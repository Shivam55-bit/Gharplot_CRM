<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reminder Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #007bff;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196f3; }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Reminder Debug Tool</h1>
        
        <div class="section">
            <h3>1. Check Service Status</h3>
            <button onclick="checkServiceStatus()">Check Global Reminder Service</button>
            <button onclick="checkToken()">Check Token</button>
        </div>

        <div class="section">
            <h3>2. Fetch Latest Reminders</h3>
            <button onclick="fetchReminders()">Fetch My Reminders</button>
            <button onclick="clearCheckedReminders()">Clear Checked Reminders Cache</button>
        </div>

        <div class="section">
            <h3>3. Time Comparison Test</h3>
            <input type="datetime-local" id="testTime" />
            <button onclick="testTimeConversion()">Test Time Conversion</button>
        </div>

        <div class="section">
            <h3>4. Force Service Check</h3>
            <button onclick="forceServiceCheck()">Force Check Now</button>
        </div>

        <div class="output" id="output"></div>
    </div>

    <script>
        const API_BASE_URL = 'https://abc.bhoomitechzone.us';
        const output = document.getElementById('output');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function checkServiceStatus() {
            log('üîç Checking Global Reminder Service...', 'info');
            
            // Check if service exists
            if (window.globalReminderService) {
                log('‚úÖ Service found!', 'success');
                log(`   - Active: ${window.globalReminderService.isActive}`, 'info');
                log(`   - Check Interval: ${window.globalReminderService.intervalDuration}ms`, 'info');
                log(`   - Checked Reminders Count: ${window.globalReminderService.checkedReminders?.size || 0}`, 'info');
                log(`   - Auto Popup Enabled: ${window.globalReminderService.enableAutoPopup}`, 'info');
            } else {
                log('‚ùå Service NOT found in window object', 'error');
                log('   Service might be inside React app context', 'warning');
            }
        }

        function checkToken() {
            log('üîë Checking authentication tokens...', 'info');
            
            const token = localStorage.getItem('token');
            const adminToken = localStorage.getItem('adminToken');
            const employeeToken = localStorage.getItem('employeeToken');
            
            if (token) log('‚úÖ token found', 'success');
            else log('‚ùå token not found', 'error');
            
            if (adminToken) log('‚úÖ adminToken found', 'success');
            else log('‚ùå adminToken not found', 'error');
            
            if (employeeToken) log('‚úÖ employeeToken found', 'success');
            else log('‚ùå employeeToken not found', 'error');
        }

        async function fetchReminders() {
            log('üìã Fetching reminders from API...', 'info');
            
            const token = localStorage.getItem('token') || 
                          localStorage.getItem('adminToken') || 
                          localStorage.getItem('employeeToken');
            
            if (!token) {
                log('‚ùå No token found. Please login first.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/employee/reminders/list?status=pending&limit=100`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                const reminders = data?.data?.reminders || data?.data || [];
                
                log(`‚úÖ Fetched ${reminders.length} pending reminders`, 'success');
                
                if (reminders.length > 0) {
                    log('üìã Reminder Details:', 'info');
                    reminders.forEach((r, i) => {
                        const reminderDate = new Date(r.reminderDateTime);
                        const now = new Date();
                        const timeDiff = now - reminderDate;
                        const minutesDiff = Math.floor(timeDiff / 60000);
                        
                        log(`\n   [${i + 1}] ${r.title || 'No Title'}`, 'info');
                        log(`       ID: ${r._id}`, 'info');
                        log(`       Stored Time: ${r.reminderDateTime}`, 'info');
                        log(`       Parsed (UTC): ${reminderDate.toISOString()}`, 'info');
                        log(`       Local Display: ${reminderDate.toLocaleString()}`, 'info');
                        log(`       Status: ${r.status}`, 'info');
                        log(`       Time Diff: ${minutesDiff} minutes ${minutesDiff < 0 ? '(future)' : '(past)'}`, minutesDiff < 0 ? 'warning' : (minutesDiff <= 5 ? 'success' : 'error'));
                        
                        // Check if it should be due
                        if (minutesDiff >= 0 && minutesDiff <= 5) {
                            log(`       ‚ö†Ô∏è THIS REMINDER SHOULD BE DUE!`, 'warning');
                        }
                    });
                } else {
                    log('‚ÑπÔ∏è No pending reminders found', 'warning');
                }
            } catch (error) {
                log(`‚ùå Error fetching reminders: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function clearCheckedReminders() {
            const count = JSON.parse(localStorage.getItem('checkedReminders') || '[]').length;
            localStorage.removeItem('checkedReminders');
            log(`‚úÖ Cleared ${count} checked reminders from cache`, 'success');
            log('   New reminders should now be able to popup again', 'info');
        }

        function testTimeConversion() {
            const testTimeInput = document.getElementById('testTime').value;
            if (!testTimeInput) {
                log('‚ùå Please select a date and time first', 'error');
                return;
            }

            log('\nüïê Testing Time Conversion...', 'info');
            log(`   Input: ${testTimeInput}`, 'info');
            
            const dateTimeObj = new Date(testTimeInput);
            log(`   Date Object: ${dateTimeObj.toString()}`, 'info');
            
            // Method 1: toISOString (with timezone conversion)
            const isoWithConversion = dateTimeObj.toISOString();
            log(`   toISOString(): ${isoWithConversion}`, 'error');
            
            // Method 2: Manual extraction (no timezone conversion)
            const year = dateTimeObj.getFullYear();
            const month = String(dateTimeObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateTimeObj.getDate()).padStart(2, '0');
            const hours = String(dateTimeObj.getHours()).padStart(2, '0');
            const minutes = String(dateTimeObj.getMinutes()).padStart(2, '0');
            const isoManual = `${year}-${month}-${day}T${hours}:${minutes}:00.000Z`;
            log(`   Manual ISO: ${isoManual}`, 'success');
            
            log('\n   How Service Will Read It:', 'info');
            const storedDate = new Date(isoManual);
            const reminderYear = storedDate.getUTCFullYear();
            const reminderMonth = storedDate.getUTCMonth();
            const reminderDay = storedDate.getUTCDate();
            const reminderHours = storedDate.getUTCHours();
            const reminderMinutes = storedDate.getUTCMinutes();
            const reminderLocalTime = new Date(reminderYear, reminderMonth, reminderDay, reminderHours, reminderMinutes);
            
            log(`   Service extracts: ${reminderLocalTime.toLocaleString()}`, 'success');
            log(`   ‚úÖ Matches input: ${reminderLocalTime.getTime() === dateTimeObj.getTime()}`, reminderLocalTime.getTime() === dateTimeObj.getTime() ? 'success' : 'error');
        }

        function forceServiceCheck() {
            log('üîÑ Forcing service check...', 'info');
            if (window.globalReminderService && window.globalReminderService.checkForDueReminders) {
                window.globalReminderService.checkForDueReminders()
                    .then(() => log('‚úÖ Check completed', 'success'))
                    .catch(err => log(`‚ùå Check failed: ${err.message}`, 'error'));
            } else {
                log('‚ùå Service not accessible from this context', 'error');
                log('   Try running this from browser console: window.globalReminderService?.checkForDueReminders()', 'info');
            }
        }

        // Auto-check on load
        setTimeout(() => {
            log('üöÄ Debug tool loaded. Select an action above.', 'success');
            checkToken();
        }, 100);
    </script>
</body>
</html>
